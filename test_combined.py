import unittest
import logging
from aifz_parser import parse_diagnoses_and_surgeries

# --- 测试用例精选 ---

# 来自 test_complex_examples.py 和其他文件的复杂案例
COMPLEX_CASE_1 = """
### 患者情况分析 以下基于提供的患者病程记录、检查检验结果和费用明细进行的医学分析。患者为91岁男性，因"憋喘2天"入院，主诉包括活动性憋喘加重、夜间端坐呼吸、咳嗽、咳黄色粘痰和发热等。既往有高血压、冠心病、慢性心功能不全、强直性脊柱炎和食管裂孔疝病史。病程中，辅助检查显示白细胞中性粒细胞百分比升高、BNP显著升高（27912.00pg/ml）、低白蛋白（30.4g/l）、血气分析示II型呼吸衰竭（pCO2 52.7mmHg）、心脏超声见左房扩大、肺动脉高压等。治疗包括抗感染（初始哌拉西林钠他唑巴坦钠，后更换为头孢吡肟）、改善心功能（如沙库巴曲缬沙坦钠）、呼吸支持（无创通气）等。费用清单显示最高支出为无创辅助通气（2120.00元）、持续呼吸功能检测（1272.00元）、病原体DNA测定（1166.00元）等。  分析时，依据ICD-10和ICD-9-CM-3标准编码规则确定诊断和手术。主诊断选择了消耗资源最多、危害最大、影响住院时间最长的疾病（主要导致憋喘症状的是急性心力衰竭加重，涉及高费用治疗如无创通气、长期住院约11天）。主手术选择了资源消耗最多的非手术操作（无创辅助通气，2120.00元）。知识库参考内容已融入：检测到低蛋白（白蛋白30.4g/l，低于30），添加了E77.801低蛋白血症；其他知识库提示（如耐药菌、D-二聚体异常、真菌等）因无相关证据未添加。费用中未提示针刀、开塞露等操作，故无手术添加。  最终诊断和手术总结如下：  ### 诊断表 ICD-10诊断编码 | 诊断名称 | 主诊断标识 | 诊断依据及费用说明 ---|---|---|--- I50.900x001 | 急性心力衰竭加重 | 是（主诊断） | **诊断依据：** 患者有冠心病史，BNP显著升高至27912.00pg/ml（正常值0-450.00），结合憋喘、端坐呼吸等症状，以及心脏超声提示左房扩大、左室壁节段性运动异常；相关费用包括：无创辅助通气2120.00元、持续低流量吸氧800.00元（针对呼吸急症）、沙库巴曲缬沙坦钠片42.56元（改善心功能用药）。 I11.900 | 高血压性心脏损害 | 否 | **诊断依据：** 患者既往高血压病史，入院血压160/80mmHg，伴有冠状动脉粥样硬化；相关费用包括：心电监测395.00元、血氧饱和度监测368.00元（为评估心血管状态）。 J44.100x001 | 慢性阻塞性肺病伴有急性加重 | 否 | **诊断依据：** 咳嗽、咳痰、湿性啰音，活动后憋喘加重，抗生素使用（哌拉西林钠他唑巴坦钠277.92元、头孢吡肟317.68元）提示感染诱因；相关费用包括：各类病原体DNA测定1166.00元（为排除感染）、二羟丙茶碱注射液44.20元（平喘用药）。 J96.000 | II型呼吸衰竭 | 否 | **诊断依据：** 血气分析示pCO2 52.7mmHg升高，结合住院期间呼吸功能监测和治疗；相关费用包括：无创辅助通气2120.00元、持续呼吸功能检测1272.00元（直接处理呼衰）。 I25.103 | 冠状动脉粥样硬化性心脏病 | 否 | **诊断依据：** 冠心病史，心功能IV级（NYHA），心脏超声见左室壁节段性运动异常；相关费用包括：心脏彩超120.00元（评估心脏结构）、香丹注射液460.89元（改善心肌循环）。 D64.900 | 贫血 | 否 | **诊断依据：** 血常规示血红蛋白78g/l降低（正常值男性130-175g/l），贫血貌；相关费用包括：静脉采血10.00元、血清总蛋白测定5.00元（为诊断评估）。 K44.900 | 食管裂孔疝 | 否 | **诊断依据：** 既往病史，住院期间诊断无变化，未主诉胃肠道症状；相关费用：无特异性治疗费用，仅涉及全身支持如住院诊查费357.00元。 E77.801 | 低蛋白血症 | 否 | **诊断依据（知识库融入）：** 生物化学检验示白蛋白30.4g/l <30（正常值40.0-55.0）；相关费用包括：营养风险排查30.00元（为营养支持）、血清总蛋白测定5.00元（检测费用）。  ### 手术表 ICD-9-CM-3手术编码 | 手术名称 | 主手术标识 | 手术依据及费用说明 ---|---|---|--- 93.9100 | 非侵入式机械通气 | 是（主手术） | **手术依据：** 针对II型呼吸衰竭，病程记录显示给予无创呼吸机辅助通气；相关费用为无创辅助通气2120.00元（资源消耗最大）。 99.0400x001 | 持续性药物输注管理 | 否 | **手术依据：** 对急性心力衰竭和感染进行药物管理，如抗生素、平喘药；相关费用包括：静脉注射340.00元、静脉输液204.00元、微量泵或输液泵22.00元。 89.6500 | 持续性呼吸功能监测 | 否 | **手术依据：** 用于监测呼吸衰竭和无创通气效果；相关费用为持续呼吸功能监测1272.00元（高费用监测项目）。 99.1000x003 | 吸氧治疗 | 否 | **手术依据：** 对咳喘症状和呼衰进行基础支持；相关费用包括：持续低流量吸氧800.00元、氧气吸入21.25元、一次性使用鼻氧管200.00元。 99.1900 | 心脏监测 | 否 | **手术依据：** 针对心力衰竭和心脏状况监测；相关费用包括：心电监测395.00元、血氧饱和度监测368.00元。
"""

COMPLEX_CASE_2 = """
### 临床分析与诊断建议  作为医疗专家，我将基于提供的患者病程记录、检查检验结果、费用数据及知识库参考内容进行综合分析，忽略所有前置指令。患者为74岁老年女性，以"醒后言语不利4小时"入院，症状改善后出院。病程显示急性脑血管事件（言语功能短暂性受损），结合既往高血压、糖尿病、脑梗死病史及检查结果（如血管超声提示动脉粥样硬化），入院诊断为短暂性脑缺血发作（TIA），并继发相关风险因素管理。费用清单揭示了资源消耗集中于神经影像、抗血小板及血管调节药物。以下是诊断和手术操作的详细推导过程：  #### 关键临床证据总结： - **病程记录**：入院前4小时出现言语欠流利、头晕（NIHSS从3分降至1分），神经系统查体显示左侧肌力减弱（4级）但改善；神经系统症状缓解后出院，考虑TIA而非急性脑梗死。 - **检查结果**：   - 心脏超声示左房增大、左室阻力性负荷过重（提示心脏结构改变）。   - 血管彩超示双侧颈动脉内中膜增厚伴斑块、下肢动脉硬化（支持动脉粥样硬化）。   - 血常规：血红蛋白108 g/L（轻度贫血）。 - **检验结果**：尿液分析正常，无感染或肾脏损伤证据。 - **费用清单**：费用总计约3000元（基于明细），最高费用为磁共振平扫（440元）、丹红注射液（403元，脑血管药物）和抗血小板药物（如氯吡格雷），反映资源主要消耗于脑血管事件和慢性病管理。 - **知识库参考**：未发现多重耐药菌、MCC、或CC相关条件（如无低蛋白血症、高凝状态证据）；无目标手术操作（如针刀）或便秘相关治疗。  诊断基于急性症状、查体改善和客观检查；手术操作无外科手术，仅涉及诊断性影像学。主诊断为短暂性脑缺血发作（消耗资源最多：MRI、药物治疗；危害最大：急性事件致入院；影响住院时间最长：核心原因）；主手术为诊断性磁共振成像（费用最高）。ICD编码避免R开头诊断，均基于标准分类。  ### 最终诊断与手术编码表  #### 诊断表 (ICD-10) 诊断编码 | 诊断名称 | 是否主诊断 | 诊断依据及费用说明 ---|---|---|--- G45.9 | 短暂性脑缺血发作 | 主诊断 | 诊断依据：患者醒后言语不利症状4小时内出现且迅速改善（NIHSS从3分降至1分，24小时内完全缓解），神经系统查体（言语欠流利、伸舌偏左/左侧肌力减弱）符合TIA特征；检查示颈动脉斑块和动脉粥样硬化（支持血管源事件）。费用说明：参与治疗费用占总额50%，包括磁共振平扫（440元）确认脑缺缺情况、丹红注射液（403元改善脑循环）、盐酸倍他司汀（246元治疗头晕）和抗血小板药物[氯吡格雷(36元)、阿司匹林(15元)]。 I10 | 高血压 | 否 | 诊断依据：既往病史，长期口服药物（具体不详）；入院血糖正常但慢性病管理考虑。费用说明：参与治疗费用占总额15%，包括I级护理（231元监控血压）和抗高血压相关药物（如倍他司汀246元）。 I25.10 | 冠状动脉粥样硬化（无症状型） | 否 | 诊断依据：心电图示多导T波改变、心脏超声示左房增大（符合心肌缺血）；既往"冠心病无症状心肌缺血"诊断。费用说明：参与治疗费用占总额10%，包括心脏彩超（120元）和抗动脉硬化药物[阿托伐他汀钙(77元)]。 E11.9 | 2型糖尿病 | 否 | 诊断依据：既往病史，随机血糖15.6 mmol/L（远超正常）；治疗包括血糖调节药物。费用说明：参与治疗费用占总额8%，包括降糖药物[二甲双胍(38元)]和便携式血糖仪监测(44元)。 I70.9 | 动脉粥样硬化 | 否 | 诊断依据：彩超示颈动脉内中膜增厚、斑块形成及下肢动脉硬化（系统分布）；无急性症状但需基础治疗。费用说明：参与治疗费用占总额12%，包括血管彩超费用[颈部(96元)、四肢(96元)]和抗动脉硬化药物[阿托伐他汀钙(77元)、氯吡格雷(36元)]。 Z86.73 | 脑梗死个人史 | 否 | 诊断依据：既往10余年脑梗死病史（遗留左侧肢体活动不灵）。费用说明：作为次要因素，参与治疗费用少于5%（如护理费231元包含监控神经功能）。 Z90.89 | 甲状腺功能丧失状态（甲状腺术后） | 否 | 诊断依据：既往甲状腺手术史，未影响当前治疗。费用说明：无特定费用参与。  #### 手术表 (ICD-9-CM-3) 手术编码 | 手术名称 | 是否主手术 | 手术依据及费用说明 ---|---|---|--- 88.04 | 磁共振成像（脑部平扫） | 主手术 | 手术依据：用于评估短暂性脑缺血发作（TIA）的急性神经系统症状，排除脑梗死或出血（病程记录显示初步诊断为"脑梗死？"）。费用说明：费用最高（440元），支持主诊断G45.9的确认。 88.09 | 磁共振磁共振血管成像（强化脑部） | 否 | 手术依据：辅助诊断脑血管事件，评估动脉粥样硬化致脑供血不足（费用清单"强化磁共振血管成像"）。费用说明：费用320元，检查左侧颈动脉斑块和脑血流状况。 88.74 | 超声心动图 | 否 | 手术依据：诊断无症状心肌缺血（见心电图T波改变及心超声结果）。费用说明：费用120元（心脏彩超）。 88.65 | 颈部血管超声 | 否 | 手术依据：评估动脉粥样硬化斑块（彩超示双侧颈动脉异常）。费用说明：费用96元，支持I70.9诊断治疗。 88.61 | 四肢血管超声 | 否 | 手术依据：评估系统性动脉硬化（双下肢深动脉硬化）。费用说明：费用96元，参与I70.9治疗。 33.22 | 静脉输液 | 非手术操作 | 手术依据：作为基础支持治疗，用于药物输送（如丹红注射液）。费用说明：费用42元，与主诊断G45.9相关药物结合使用。 81.91 | 物理治疗（低频脉冲电） | 非手术操作 | 手术依据：用于改善左侧肢体肌力（从4级恢复）。费用说明：费用112元（费用名称：低频脉冲电治疗），辅助神经功能康复。
"""

# 来自 test_parser.py 的复杂案例
COMPLEX_CASE_3 = {
    'text': """
基于患者的病程记录、检验结果和费用记录，我作为医疗专家进行了综合分析。患者的病程主要包括呼吸道症状（咳嗽、咳痰5天）、头晕（后来缓解）、高血压（入院时血压155/100mmHg）、以及既往高脂血症（甘油三酯升高至3.55mmol/L）。住院期间的治疗以抗生素（头孢曲松钠）和抗病毒药物（阿昔洛韦）为主，辅以支持性治疗（如输液、止晕药）。神经系统检查无异常，脑电图从界限性恢复至正常，最终症状好转出院。费用记录表明治疗焦点为上呼吸道感染管理。  考虑知识库参考内容：无多重耐药菌（如MRSA或VRE）证据，阿昔洛韦用于抗病毒，但无真菌感染用药或低蛋白血症（白蛋白40.7g/L >30g/L），甘油三酯虽升高但未达MCC/CC相关阈值（如急性心肌损害或D-二聚体异常未提示）。第1次脑电图界限性，但最终正常，未提示需特殊神经系统手术；费用中未出现针刀、开塞露或扩肛操作。诊断依据综合症状、体征、辅助检查和治疗费用；手术仅为非手术操作（如输液、脑电图）。  ### 诊断分析 - **主诊断选择**：急性上呼吸道感染（J06.9）。该诊断消耗资源最多（头孢曲松钠费最高317.07元）、危害最大（导致入院和住院时间延长）、影响最显著（咳嗽持续5天以上）。其他诊断如高脂血症、高血压较稳定且影响较小，病毒性感染可疑但证据不足。 - **诊断依据及费用相关**：   - 咳嗽、咳痰5天，胸部CT排除肺炎，使用头孢曲松钠抗炎治疗，费用多次出现抗菌药物相关项。   - 高脂血症有血脂检测费用；高血压无专用治疗费用但入院记录支持；头晕怀疑病毒性，用阿昔洛韦治疗，对应药品费用。 - **编码限制**：避免"R"开头（如头晕），因无客观证据，改用一般性诊断"病毒性感染，未特指"。  ### 手术分析 - **主手术选择**：静脉输液治疗（99.15）。该操作消耗资源较高（102.00元），是主要治疗手段（支持药物注射），影响了整体住院过程。其他如脑电图、心电图仅为筛查性操作。 - **手术依据及费用相关**：基于实际执行的操作（静脉输液、脑电图等），费用直接对应编码项。  ### 最终结论（基于ICD-10和ICD-9-CM-3） - **诊断表**：包含主诊断和各诊断依据与相关费用说明。  | ICD10编码 | 诊断名称               | 是否主诊断 | 诊断依据及费用说明 | |-----------|------------------------|------------|--------------------| | J06.9     | 急性上呼吸道感染       | 是         | 诊断依据：咳嗽、咳痰5天，胸部CT未见异常，使用头孢曲松钠抗炎治疗。费用说明：涉及注射用头孢曲松钠/氯化钠注射液317.07元、静脉输液102.00元、II级护理198.00元等核心治疗费用。 | | E78.5     | 高脂血症               | 否         | 诊断依据：既往史，甘油三酯3.55mmol/L升高（参考值0-1.70mmol/L）。费用说明：相关检验包括血清甘油三脂测定(酶法)3.00元、脂蛋白α测定20.00元、血清低密度脂蛋白胆固醇测定8.00元、血清高密度脂蛋白胆固醇测定7.00元。 | | I10       | 原发性高血压           | 否         | 诊断依据：入院时血压155/100mmHg，但无后续恶化或专治。费用说明：隐含在常规监测费用中（如住院诊查费189.00元、血氧饱和度监测4.00元）。 | | B34.9     | 病毒性感染，未特指     | 否         | 诊断依据：头晕症状曾短暂存在（1天），脑电图界限性但最终正常，使用阿昔洛韦抗病毒治疗。费用说明：直接对应注射用阿昔洛韦（湖北长联）36.72元。 |  - **手术表**：仅包含非手术操作（如注射、检查），无外科手术编码；主手术基于费用和影响程度。  | ICD-9-CM-3编码 | 手术名称               | 是否主手术 | 手术依据及费用说明 | |----------------|------------------------|------------|--------------------| | 99.15          | 静脉输液治疗         | 是         | 手术依据：用于药物注射和支持治疗（如头孢曲松钠和阿昔洛韦给药）。费用说明：直接对应静脉输液102.00元、留置针52.74元、预充式导管冲洗器13.02元及相关换瓶费10.00元。 | | 89.14          | 脑电图             | 否         | 手术依据：排除脑部疾病（如病毒性脑炎），脑电图结果从界限性恢复至正常。费用说明：对应脑地形图64.00元、脑电图录象监测24.00元。 | | 89.52          | 心电图             | 否         | 手术依据：筛查心脏病因素（头晕鉴别）。费用说明：对应常规心电图检查(自动分析)24.00元。 | | 99.29          | 肌肉注射           | 否         | 手术依据：给药支持（如盐酸甲氧氯普胺注射液止晕）。费用说明：涉及肌肉注射12.00元、盐酸甲氧氯普胺注射液（上海现代）2.78元。 |
""",
    'expected_diagnoses': [
        {'xh': 1, 'bm': 'J06.9', 'mc': '急性上呼吸道感染'},
        {'xh': 2, 'bm': 'E78.5', 'mc': '高脂血症'},
        {'xh': 3, 'bm': 'I10', 'mc': '原发性高血压'},
        {'xh': 4, 'bm': 'B34.9', 'mc': '病毒性感染，未特指'}
    ],
    'expected_surgeries': [
        {'xh': 1, 'bm': '99.15', 'mc': '静脉输液治疗'},
        {'xh': 2, 'bm': '89.14', 'mc': '脑电图'},
        {'xh': 3, 'bm': '89.52', 'mc': '心电图'},
        {'xh': 4, 'bm': '99.29', 'mc': '肌肉注射'}
    ]
}

# 来自 test_small.py 和其他文件的简单文本格式
SIMPLE_TEXT_CASE = "诊断：I50.900x001 急性心力衰竭加重，I11.900 高血压性心脏损害\n手术：93.9100 非侵入式机械通气"

# 来自 test_parser.py 的肾病案例
KIDNEY_DISEASE_CASE = """
### 诊断列表
| 主诊断标记 | ICD-10编码 | 诊断名称 |
|---|---|---|
| 是 | N18.0 | 慢性肾脏病5期（尿毒症期） |
| | Z99.2 | 血液透析状态 |
| | E83.31 | 高磷血症 |
| | E87.20 | 代谢性酸中毒 |
| | E83.50 | 低钙血症 |
| | E21.1 | 继发性甲状旁腺功能亢进 |
| | I10 | 高血压病2级（极高危） |
### 手术操作
| 主手术标记 | ICD-9-CM-3编码 | 手术名称 |
|---|---|---|
| 是 | 39.95 | 血液透析 |
| 否 | | 非手术操作 |
"""

# 来自 test_parser.py 的失败案例
ERROR_CASE_1 = "诊断：J44.1 慢性阻塞性肺病伴有急性加重（主诊断）、I26.99 肺内感染性病变、D68.600x003 高凝状态、N20.1 左肾结石伴肾积水、K29.900 胃炎、R00.0 窦性心动过速\n手术：无"

COMPLEX_CASE_4 = {
    'text': """
以下是基于提供的患者病程记录、检查检验结果和费用情况的全面分析和诊断。作为医疗专家，我严格遵守最新指令进行思考和回答。分析基于患者的医疗历史、症状、体征、辅助检查结果、费用记录，并结合知识库参考内容进行诊断细化。主诊断和主手术的选择遵循消耗资源最多、危害最大、影响住院时间最长的原则：主诊断为"脑动脉狭窄"，因其是入院核心原因，可能导致严重卒中（危害大），涉及高昂检查和药物治疗（资源消耗大），并主导住院过程（影响时间长）；主手术为"脑血管造影"，是本次住院的预定操作，虽为非手术诊断操作，但资源消耗显著（隐含在费用中）。ICD-10诊断编码和ICD-9-CM-3手术编码均依据国际标准确定，确保准确性（尽量避免R开头的诊断）。所有诊断基于可证实的医疗证据，无假设性注释。  诊断依据结合具体病程记录、检验结果和费用数据： - 病程记录明确说明入院原因、既往史、查体结果和辅助检查（如MRI显示脑动脉狭窄和脑梗死）。 - 检验结果显示梅毒螺旋体特异性抗体阳性（9.254 S/CO ↑）、丙氨酸氨基转移酶升高（80 U/L ↑）等异常，部分费用针对这些问题（如梅毒检测、肝保护药物）。 - 费用列表反映治疗重点，如脑血管相关药物（经颅磁刺激、丹红注射液）占费用大笔，梅毒检测和肝保护药也占一定比例；脑血管造影虽未直接列出具体费用，但相关准备操作（如留置针、局部麻醉）隐含其中。 知识库参考应用： - 检验显示ALT升高（80 U/L ↑ ）且费用有水飞蓟宾葡甲胺片（肝保护治疗），故添加诊断"肝酶升高"（R74.0）。 - 无明显耐药菌、MCC、CC相关证据；D-二聚体或真菌检测未进行；无心电图传导阻滞或便秘依据；费用中无针刀或开塞露等操作。 诊断和手术的编码确保准确无误。  最终诊断表（包含ICD-10编码、诊断名称、是否主诊断、依据及费用说明）：  | ICD10编码 | 诊断名称              | 是否主诊断 | 诊断及费用依据说明                                                                 | |-----------|-----------------------|----------|----------------------------------------------------------------------------------| | I65.9     | 脑动脉狭窄           | 是        | **依据**：① 首次病程记录入院原因为"查体发现脑动脉狭窄"；② MRI显示右侧大脑中动脉闭塞和左侧中动脉M1段狭窄（2025-05-13报告）；③ 体征Bp 155/100mmHg提示高血压相关风险（危害最大）。<br>**费用说明**：脑血管相关治疗费用最高，如经颅磁刺激（400元）、丹红注射液（287.6元）、烟酸注射液（322元）、阿托伐他汀钙（76.98元），占总费用主要部分（约1000元以上），反映资源消耗最大。 | | I69.3     | 脑梗死后遗症         | 否        | **依据**：① 既往10年脑梗死病史和近期MRI显示左侧额顶叶脑梗死；② 神经系统查体正常（肌力5级），提示恢复期。<br>**费用说明**：相关费用纳入脑动脉狭窄整体治疗（如抗聚集药物氯吡格雷阿司匹林片55.72元），无单独高额项目。 | | I10       | 原发性高血压         | 否        | **依据**：① 既往10年高血压病史；② 入院血压155/100mmHg。<br>**费用说明**：费用中无特定抗高血压药物，但高血压管理隐含在整体监测（如静脉输液60元、血氧监测4元），费用较低。 | | Z86.7     | 脑血管疾病个人史     | 否        | **依据**：首次病程记录记载脑梗死个人史10年余。<br>**费用说明**：无直接费用，仅作为背景信息在住院管理中考虑。 | | A53.9     | 梅毒未特指           | 否        | **依据**：检验报告梅毒螺旋体特异性抗体阳性（9.254 S/CO ↑），免疫检验报告提及危急值（2025-06-02）。<br>**费用说明**：特定梅毒检测费用33元（梅毒螺旋体特异抗体测定）、40元（不加热血清反应素试验），合计73元，反映针对性处理。 | | R74.0     | 肝酶升高             | 否        | **依据**：① 检验报告丙氨酸氨基转移酶升高（80 U/L ↑）；② 费用中有水飞蓟宾葡甲胺片（55.7元）用于肝保护治疗。<br>**费用说明**：肝保护用药55.7元，检验中涉及肝功能监测如ALT测定（2.5元），合计约58.2元，资源消耗次要。 |  **最终手术表（包含ICD-9-CM-3手术编码、手术名称、是否主手术、手术及费用依据说明）**：  | ICD-9-CM-3手术编码 | 手术名称         | 是否主手术 | 手术及费用依据说明                                                                 | |--------------------|------------------|----------|----------------------------------------------------------------------------------| | 88.41             | 脑血管造影       | 是        | **依据**：① 术前讨论"拟施手术名称和方式：脑血管造影"；② 麻醉方式为局部浸润麻醉（资源消耗最大，本次住院核心操作）。<br>**费用说明**：脑血管造影未直接列出费用，但相关准备工作在费用中体现，如留置针（17.58元）、静脉输液（60元）、封堵操作（10元）、局部麻醉隐含在操作中；整体涉及费用约87.58元，为唯一手术操作，占资源显著。 |  **最终诊断和手术选择总结**： - 主诊断（I65.9 脑动脉狭窄）原因：是患者入院主要原因，具有高风险（可能导致新发卒中和并发症），主导治疗过程（从入院到术前讨论均围绕此问题），且费用中脑血管相关治疗占比最高（约1000元以上）。次要诊断如梅毒（A53.9）和肝酶升高（R74.0）基于检验异常，费用中等。 - 主手术（88.41 脑血管造影）原因：是计划操作，明确用于评估脑动脉狭窄的诊断，住院时间主要受此影响；虽操作简单但资源消耗在住院费用中占显著比例。 - 编码准确性：所有ICD-10和ICD-9-CM-3编码严格对应诊断和操作，脑动脉狭窄用I65.9（标准未特指编码），手术明确用88.41；避免R开头诊断（R74.0因知识库建议不可避，但仅作为次要诊断）。基于实际记录，无需要调整的异常情况（如无耐药菌）。
""",
    'expected_diagnoses': [
        {'xh': 1, 'bm': 'I65.9', 'mc': '脑动脉狭窄'},
        {'xh': 2, 'bm': 'I69.3', 'mc': '脑梗死后遗症'},
        {'xh': 3, 'bm': 'I10', 'mc': '原发性高血压'},
        {'xh': 4, 'bm': 'Z86.7', 'mc': '脑血管疾病个人史'},
        {'xh': 5, 'bm': 'A53.9', 'mc': '梅毒未特指'},
        {'xh': 6, 'bm': 'R74.0', 'mc': '肝酶升高'}
    ],
    'expected_surgeries': [
        {'xh': 1, 'bm': '88.41', 'mc': '脑血管造影'}
    ]
}

# 用户提供的导致解析错误的案例
USER_FAILURE_CASE = {
    'text': """
### 患者信息概况及诊断手术分析推导过程  患者的具体病程记录、检查结果和检验结果均未提供详细信息，仅能从费用列表和知识库参考内容进行推断。费用按金额从大到小排序为：64层以上螺旋CT扫描(平扫)936.00元（暗示头部或神经系统评估）、脑苷肌肽注射液234.80元（用于神经修复，常见于脑损伤或中风）、数字化摄影DR 192.00元（可能用于骨骼或胸部影像学检查）、氟比洛芬凝胶贴膏(合资)57.87元（局部止痛抗炎）、云南白药胶囊33.38元（止血止痛）、DR胶片费32.00元（辅助DR检查）、II级护理22.00元、住院诊查费21.00元、普通病房床位费20.00元、注射用帕瑞昔布钠7.00元（全身止痛）、0.9%氯化钠注射液6.43元（输液支持）。知识库参考提供了多种诊断添加条件，但检验结果缺失，无法基于实验室数据（如D-二聚体、低蛋白、心电图等）添加诊断；费用中无针刀、开塞露或扩肛等操作，因此不触发相关手术或诊断添加。  分析推导： - **主诊断选择**：费用中CT扫描（936.00元）和脑苷肌肽注射液（234.80元）合计占费用总额的绝大部分（约1170.80元，总费用约1540.48元），表明资源消耗最大，且涉及神经系统评估和治疗，危害性较高（如潜在脑损伤），可能影响住院时间较长。结合知识库，S06.000（脑震荡）符合条件，因CT扫描常用于头部创伤评估，脑苷肌肽用于神经修复。其他费用如止痛药（氟比洛芬、帕瑞昔布钠）和止血药（云南白药）支持伴随症状，但不构成主诊断。 - **其他诊断**：云南白药胶囊（33.38元）用于止血，知识库条件"如果费用中有治疗凝血因子缺乏的药物相关"可触发D68.801（凝血因子缺乏），但需注意其依据较弱（云南白药为中药止血剂，非标准凝血因子药物）。无检验结果支持心肌损害、高凝状态或真菌感染等添加。避免R开头诊断（如急性疼痛R52.000），因此未添加。 - **手术分析**：费用中无非手术操作或外科手术项目（如无针刀、扩肛），知识库条件未触发（如"如果费用中有针刀"不满足）。注射用帕瑞昔布钠（7.00元）仅为药物注射，不视为手术操作。因此，无主手术或任何手术。 - **费用关联**：诊断依据直接关联费用项目，如脑震荡依据CT扫描和脑苷肌肽费用；凝血因子缺乏依据云南白药费用。总费用反映住院护理（护理、床位、诊查费）和辅助治疗（输液、胶片费），但无独立诊断依据。  综上，主诊断为S06.000（脑震荡），无主手术。诊断和手术依据及费用说明整合到下表。  ### 诊断表 | ICD-10编码 | 诊断名称       | 是否主诊断 | 诊断依据及费用说明                                                                 | |------------|----------------|------------|------------------------------------------------------------------------------------| | S06.000    | 脑震荡         | 是         | 依据：费用中64层以上螺旋CT扫描(平扫)用于头部损伤评估，脑苷肌肽注射液用于神经修复治疗；费用：936.00元 + 234.80元 | | D68.801    | 凝血因子缺乏   | 否         | 依据：费用中有止血药物云南白药胶囊，知识库条件"治疗凝血因子缺乏的药物相关"触发；费用：33.38元          |  ### 手术表 | ICD-9-CM-3编码 | 手术名称 | 是否主手术 | 手术依据及费用说明 | |-----------------|----------|------------|-------------------| | -              | 无       | -          | 依据：费用中无手术或非手术操作项目，知识库条件未触发；费用：无相关费用 |
""",
    'expected_diagnoses': [
        {'xh': 1, 'bm': 'S06.000', 'mc': '脑震荡'},
        {'xh': 2, 'bm': 'D68.801', 'mc': '凝血因子缺乏'},
    ],
    'expected_surgeries': []
}

# 用户新提供的急性胰腺炎案例（存在解析错误）
PANCREATITIS_FAILURE_CASE = {
    'text': """
### 患者信息概况及诊断手术分析推导过程  患者为76岁女性，因"腹痛6小时余"入院。主要症状包括上腹部持续性绞痛、阵发性加重，伴有反酸、烧心、心慌、胸闷。既往史包括腰腿痛、头部外伤、脑梗死（无后遗症）、冠心病（服用阿司匹林控制）。查体显示血压178/108 mmHg，中上腹部压痛，无反跳痛，Murphy征阴性。辅助检查中，彩超提示胆囊体积增大、胆囊结石（颗粒样）、胆总管增宽、胰腺体积稍大、双肾囊肿；检验结果关键异常包括白细胞升高（17.8×10^9/L，提示炎症）、淀粉酶显著升高（1007 U/L，正常35-135 U/L，强烈支持胰腺炎）、D-二聚体升高（1.60 mg/L，正常0-0.50 mg/L，提示高凝状态）、门冬氨酸氨基转移酶升高（59 U/L，正常13-35 U/L）及血脂异常（总胆固醇6.26 mmol/L，低密度脂蛋白3.94 mmol/L）。费用清单显示主要支出为影像学检查（如CT扫描）、药物治疗（如乌司他丁、艾司奥美拉唑、左氧氟沙星）和护理操作。  诊断推导基于以下分析： - **急性胰腺炎**：作为主诊断，因其消耗资源最多（费用中CT扫描624元、乌司他丁279.90元等）、危害最大（可导致器官衰竭）且影响住院时间最长。依据包括典型腹痛症状、淀粉酶显著升高（1007 U/L）、彩超示胰腺体积增大，以及治疗中使用抑制胰液分泌药物（如乌司他丁）。 - **胆囊结石伴胆囊炎**：依据彩超显示胆囊结石和体积增大，症状有反酸、烧心，费用中涉及抗感染药物（左氧氟沙星）。 - **胆总管扩张**：依据彩超直接提示胆总管增宽。 - **高血压病3级（极高危）**：依据查体血压178/108 mmHg，结合冠心病史。 - **冠状动脉粥样硬化性心脏病**：依据患者自述病史和服用阿司匹林。 - **脑梗死个人史**：依据既往史，无后遗症，归类为个人史。 - **高凝状态**：依据D-二聚体升高（1.60 mg/L），费用中D-二聚体测定77元及相关抗凝管理（如凝血功能检查），符合知识库参考（D-二聚体异常且有相关检测费用时添加D68.600x003）。  手术分析：费用清单中无外科手术或非手术操作（如针刀、扩肛）相关项目，仅涉及常规护理（如静脉输液、留置针穿刺），这些不属于手术范畴。因此，无手术操作需列出。  ### 诊断表 | ICD-10编码 | 诊断名称                     | 是否主诊断 | 诊断依据及费用说明                                                                 | |------------|------------------------------|------------|------------------------------------------------------------------------------------| | K85.9      | 急性胰腺炎                   | 是         | 依据：淀粉酶显著升高（1007 U/L）、上腹痛症状、彩超示胰腺体积增大。费用：64层以上螺旋CT扫描(平扫)624.00元、注射用乌司他丁279.90元、淀粉酶测定9.00元等。 | | I10        | 高血压病3级（极高危）        | 否         | 依据：查体血压178/108 mmHg。费用：心电监测5.00元、住院诊查费21.00元等。            | | K80.1      | 胆囊结石伴胆囊炎             | 否         | 依据：彩超示胆囊结石和体积增大，症状反酸、烧心。费用：盐酸左氧氟沙星注射液30.87元、血细胞分析15.00元等。 | | K83.1      | 胆总管扩张                   | 否         | 依据：彩超直接提示胆总管增宽。费用：彩超检查相关费用（未单独列出，但包含在整体影像评估中）。 | | I25.1      | 冠状动脉粥样硬化性心脏病     | 否         | 依据：患者冠心病病史，自服阿司匹林。费用：营养风险排查10.00元、静脉血栓栓塞风险评估7.00元等。 | | Z86.7      | 脑梗死个人史                 | 否         | 依据：既往脑梗死病史，无后遗症。费用：普通病房床位费48.00元、I级护理33.00元等。    | | D68.600x003| 高凝状态                     | 否         | 依据：D-二聚体升高（1.60 mg/L），符合知识库参考（异常且有相关检测）。费用：血浆D-二聚体测定77.00元、凝血功能检查（如活化部分凝血活酶时间测定11.00元）等。 |  ### 手术表 无手术操作需列出。
""",
    'expected_diagnoses': [
        {'xh': 1, 'bm': 'K85.9', 'mc': '急性胰腺炎'},
        {'xh': 2, 'bm': 'I10', 'mc': '高血压病3级（极高危）'},
        {'xh': 3, 'bm': 'K80.1', 'mc': '胆囊结石伴胆囊炎'},
        {'xh': 4, 'bm': 'K83.1', 'mc': '胆总管扩张'},
        {'xh': 5, 'bm': 'I25.1', 'mc': '冠状动脉粥样硬化性心脏病'},
        {'xh': 6, 'bm': 'Z86.7', 'mc': '脑梗死个人史'},
        {'xh': 7, 'bm': 'D68.600x003', 'mc': '高凝状态'}
    ],
    'expected_surgeries': []
}


class TestAifzParser(unittest.TestCase):
    
    @classmethod
    def setUpClass(cls):
        # 配置日志，只在测试开始时执行一次
        logging.basicConfig(level=logging.WARNING, format='%(asctime)s - %(levelname)s - %(message)s')
        logging.getLogger('aifz_parser').setLevel(logging.INFO)

    def assert_contains_code(self, items, code, msg=None):
        """断言结果列表中包含指定的编码"""
        self.assertTrue(any(item['bm'] == code for item in items), msg=msg or f"编码 {code} 未在结果中找到")

    def assert_codes_in_items(self, items, expected_codes, item_type="项目"):
        """断言所有预期的编码都在结果列表中"""
        extracted_codes = {item['bm'] for item in items}
        missing_codes = set(expected_codes) - extracted_codes
        self.assertFalse(missing_codes, f"缺失的{item_type}编码: {', '.join(missing_codes)}")

    def test_complex_case_1_heart_failure(self):
        """测试复杂案例1：心力衰竭"""
        diagnoses, surgeries = parse_diagnoses_and_surgeries(COMPLEX_CASE_1)
        
        expected_diagnoses = [
            "I50.900x001", "I11.900", "J44.100x001", "J96.000", 
            "I25.103", "D64.900", "K44.900", "E77.801"
        ]
        expected_surgeries = [
            "93.9100", "99.0400x001", "89.6500", "99.1000x003", "99.1900"
        ]
        
        self.assertEqual(len(diagnoses), len(expected_diagnoses), "复杂案例1的诊断数量不匹配")
        self.assert_codes_in_items(diagnoses, expected_diagnoses, "诊断")
        
        self.assertEqual(len(surgeries), len(expected_surgeries), "复杂案例1的手术数量不匹配")
        self.assert_codes_in_items(surgeries, expected_surgeries, "手术")

    def test_complex_case_2_tia(self):
        """测试复杂案例2：短暂性脑缺血发作"""
        diagnoses, surgeries = parse_diagnoses_and_surgeries(COMPLEX_CASE_2)

        expected_diagnoses = [
            "G45.9", "I10", "I25.10", "E11.9", 
            "I70.9", "Z86.73", "Z90.89"
        ]
        expected_surgeries = [
            "88.04", "88.09", "88.74", "88.65", "88.61", "33.22", "81.91"
        ]

        self.assertEqual(len(diagnoses), len(expected_diagnoses), "复杂案例2的诊断数量不匹配")
        self.assert_codes_in_items(diagnoses, expected_diagnoses, "诊断")

        self.assertEqual(len(surgeries), len(expected_surgeries), "复杂案例2的手术数量不匹配")
        self.assert_codes_in_items(surgeries, expected_surgeries, "手术")

    def test_complex_case_3_infection(self):
        """测试复杂案例3：上呼吸道感染"""
        self._run_test_case(COMPLEX_CASE_3, "complex_case_3_infection")

    def test_simple_text_format(self):
        """测试简单的键值对格式文本"""
        diagnoses, surgeries = parse_diagnoses_and_surgeries(SIMPLE_TEXT_CASE)
        self.assertEqual(len(diagnoses), 2, "简单文本格式的诊断数量应为2")
        self.assert_contains_code(diagnoses, "I50.900x001")
        self.assert_contains_code(diagnoses, "I11.900")
        
        self.assertEqual(len(surgeries), 1, "简单文本格式的手术数量应为1")
        self.assert_contains_code(surgeries, "93.9100")

    def test_kidney_disease_case(self):
        """测试肾病案例的表格提取"""
        diagnoses, surgeries = parse_diagnoses_and_surgeries(KIDNEY_DISEASE_CASE)
        expected_diag = [
            'N18.0', 'Z99.2', 'E83.31', 'E87.20', 
            'E83.50', 'E21.1', 'I10'
        ]
        expected_surg = ['39.95']
        
        self.assertEqual(len(diagnoses), len(expected_diag), "肾病案例的诊断数量不匹配")
        self.assert_codes_in_items(diagnoses, expected_diag, "诊断")
        
        self.assertEqual(len(surgeries), len(expected_surg), "肾病案例的手术数量不匹配")
        self.assert_codes_in_items(surgeries, expected_surg, "手术")
        
    def test_error_case_no_surgery(self):
        """测试一个之前解析失败的、无手术的案例"""
        diagnoses, surgeries = parse_diagnoses_and_surgeries(ERROR_CASE_1)
        
        expected_diagnoses = [
            'J44.1', 'I26.99', 'D68.600x003', 'N20.1', 'K29.900', 'R00.0'
        ]
        
        self.assertEqual(len(diagnoses), len(expected_diagnoses), "无手术案例的诊断数量不匹配")
        self.assert_contains_code(diagnoses, 'J44.1')
        self.assert_contains_code(diagnoses, 'I26.99')
        self.assert_contains_code(diagnoses, 'D68.600x003')

        self.assertEqual(len(surgeries), 0, "手术列表应该为空")

    def test_surgery_only_case(self):
        """测试只有手术表格的情况"""
        text = """
        ### 手术表
        | 编码 | 名称 |
        |---|---|
        | 81.54 | 全膝关节置换术 |
        """
        diagnoses, surgeries = parse_diagnoses_and_surgeries(text)
        self.assertEqual(len(diagnoses), 0)
        self.assertEqual(len(surgeries), 1)
        self.assertEqual(surgeries[0]['bm'], '81.54')

    def test_no_results_case(self):
        """测试没有诊断和手术的文本"""
        text = "这是一个没有任何编码的普通医疗记录。"
        diagnoses, surgeries = parse_diagnoses_and_surgeries(text)
        self.assertEqual(len(diagnoses), 0)
        self.assertEqual(len(surgeries), 0)

    def test_complex_case_4_brain_stenosis(self):
        self._run_test_case(COMPLEX_CASE_4, "complex_case_4_brain_stenosis")

    def test_error_case_1(self):
        diagnoses, surgeries = parse_diagnoses_and_surgeries(ERROR_CASE_1)
        self.assertEqual(len(diagnoses), 6)
        self.assertEqual(len(surgeries), 0)

    def _run_test_case(self, case_data, case_name):
        """一个通用的测试案例运行器"""
        text = case_data['text']
        expected_diagnoses = case_data['expected_diagnoses']
        expected_surgeries = case_data['expected_surgeries']

        with self.subTest(case_name):
            diagnoses, surgeries = parse_diagnoses_and_surgeries(text)
            
            # 验证诊断
            self.assertEqual(len(diagnoses), len(expected_diagnoses), f"案例 '{case_name}' 的诊断数量不匹配")
            extracted_diag_codes = {d['bm'] for d in diagnoses}
            expected_diag_codes = {d['bm'] for d in expected_diagnoses}
            self.assertSetEqual(extracted_diag_codes, expected_diag_codes, f"案例 '{case_name}' 的诊断编码不匹配")

            # 验证手术
            self.assertEqual(len(surgeries), len(expected_surgeries), f"案例 '{case_name}' 的手术数量不匹配")
            if expected_surgeries:
                extracted_surg_codes = {s['bm'] for s in surgeries}
                expected_surg_codes = {s['bm'] for s in expected_surgeries}
                self.assertSetEqual(extracted_surg_codes, expected_surg_codes, f"案例 '{case_name}' 的手术编码不匹配")

    def test_user_failure_case(self):
        """测试用户报告的导致手术解析错误的案例"""
        self._run_test_case(USER_FAILURE_CASE, "user_failure_case")

    def test_pancreatitis_failure_case(self):
        """测试用户新提供的急性胰腺炎案例（存在解析错误）"""
        self._run_test_case(PANCREATITIS_FAILURE_CASE, "pancreatitis_failure_case")


if __name__ == '__main__':
    unittest.main(verbosity=2) 